'usestrict';constModule=require('module');constcrypto=require('crypto');constfs=require('fs');constpath=require('path');constvm=require('vm');constos=require('os');consthasOwnProperty=Object.prototype.hasOwnProperty;//------------------------------------------------------------------------------//FileSystemBlobStore//------------------------------------------------------------------------------classFileSystemBlobStore{constructor(directory,prefix){constname=prefix?slashEscape(prefix+'.'):'';this._blobFilename=path.join(directory,name+'BLOB');this._mapFilename=path.join(directory,name+'MAP');this._lockFilename=path.join(directory,name+'LOCK');this._directory=directory;this._load();}has(key,invalidationKey){if(hasOwnProperty.call(this._memoryBlobs,key)){returnthis._invalidationKeys[key]===invalidationKey;}elseif(hasOwnProperty.call(this._storedMap,key)){returnthis._storedMap[key][0]===invalidationKey;}returnfalse;}get(key,invalidationKey){if(hasOwnProperty.call(this._memoryBlobs,key)){if(this._invalidationKeys[key]===invalidationKey){returnthis._memoryBlobs[key];}}elseif(hasOwnProperty.call(this._storedMap,key)){constmapping=this._storedMap[key];if(mapping[0]===invalidationKey){returnthis._storedBlob.slice(mapping[1],mapping[2]);}}}set(key,invalidationKey,buffer){this._invalidationKeys[key]=invalidationKey;this._memoryBlobs[key]=buffer;this._dirty=true;}delete(key){if(hasOwnProperty.call(this._memoryBlobs,key)){this._dirty=true;deletethis._memoryBlobs[key];}if(hasOwnProperty.call(this._invalidationKeys,key)){this._dirty=true;deletethis._invalidationKeys[key];}if(hasOwnProperty.call(this._storedMap,key)){this._dirty=true;deletethis._storedMap[key];}}isDirty(){returnthis._dirty;}save(){constdump=this._getDump();constblobToStore=Buffer.concat(dump[0]);constmapToStore=JSON.stringify(dump[1]);try{mkdirpSync(this._directory);fs.writeFileSync(this._lockFilename,'LOCK',{flag:'wx'});}catch(error){//Swallowtheexceptionifwefailtoacquirethelock.returnfalse;}try{fs.writeFileSync(this._blobFilename,blobToStore);fs.writeFileSync(this._mapFilename,mapToStore);}catch(error){throwerror;}finally{fs.unlinkSync(this._lockFilename);}returntrue;}_load(){try{this._storedBlob=fs.readFileSync(this._blobFilename);this._storedMap=JSON.parse(fs.readFileSync(this._mapFilename));}catch(e){this._storedBlob=Buffer.alloc(0);this._storedMap={};}this._dirty=false;this._memoryBlobs={};this._invalidationKeys={};}_getDump(){constbuffers=[];constnewMap={};letoffset=0;functionpush(key,invalidationKey,buffer){buffers.push(buffer);newMap[key]=[invalidationKey,offset,offset+buffer.length];offset+=buffer.length;}for(constkeyofObject.keys(this._memoryBlobs)){constbuffer=this._memoryBlobs[key];constinvalidationKey=this._invalidationKeys[key];push(key,invalidationKey,buffer);}for(constkeyofObject.keys(this._storedMap)){if(hasOwnProperty.call(newMap,key))continue;constmapping=this._storedMap[key];constbuffer=this._storedBlob.slice(mapping[1],mapping[2]);push(key,mapping[0],buffer);}return[buffers,newMap];}}//------------------------------------------------------------------------------//NativeCompileCache//------------------------------------------------------------------------------classNativeCompileCache{constructor(){this._cacheStore=null;this._previousModuleCompile=null;}setCacheStore(cacheStore){this._cacheStore=cacheStore;}install(){constself=this;consthasRequireResolvePaths=typeofrequire.resolve.paths==='function';this._previousModuleCompile=Module.prototype._compile;Module.prototype._compile=function(content,filename){constmod=this;functionrequire(id){returnmod.require(id);}//https://github.com/nodejs/node/blob/v10.15.3/lib/internal/modules/cjs/helpers.js#L28functionresolve(request,options){returnModule._resolveFilename(request,mod,false,options);}require.resolve=resolve;//https://github.com/nodejs/node/blob/v10.15.3/lib/internal/modules/cjs/helpers.js#L37//resolve.resolve.pathswasaddedinv8.9.0if(hasRequireResolvePaths){resolve.paths=functionpaths(request){returnModule._resolveLookupPaths(request,mod,true);};}require.main=process.mainModule;//Enablesupporttoaddextraextensiontypesrequire.extensions=Module._extensions;require.cache=Module._cache;constdirname=path.dirname(filename);constcompiledWrapper=self._moduleCompile(filename,content);//Weskipthedebuggersetupbecausebythetimewerun,nodehasalready//donethatitself.//`Buffer`isincludedforElectron.//Seehttps://github.com/zertosh/v8-compile-cache/pull/10#issuecomment-518042543constargs=[mod.exports,require,mod,filename,dirname,process,global,Buffer];returncompiledWrapper.apply(mod.exports,args);};}uninstall(){Module.prototype._compile=this._previousModuleCompile;}_moduleCompile(filename,content){//https://github.com/nodejs/node/blob/v7.5.0/lib/module.js#L511//RemoveshebangvarcontLen=content.length;if(contLen>=2){if(content.charCodeAt(0)===35/*#*/&&content.charCodeAt(1)===33/*!*/){if(contLen===2){//Exactmatchcontent='';}else{//Findendofshebanglineandsliceitoffvari=2;for(;i<contLen;++i){varcode=content.charCodeAt(i);if(code===10/*\n*/||code===13/*\r*/)break;}if(i===contLen){content='';}else{//Notethatthisactuallyincludesthenewlinecharacter(s)inthe//newoutput.Thisduplicatesthebehavioroftheregular//expressionthatwaspreviouslyusedtoreplacetheshebanglinecontent=content.slice(i);}}}}//createwrapperfunctionvarwrapper=Module.wrap(content);varinvalidationKey=crypto.createHash('sha1').update(content,'utf8').digest('hex');varbuffer=this._cacheStore.get(filename,invalidationKey);varscript=newvm.Script(wrapper,{filename:filename,lineOffset:0,displayErrors:true,cachedData:buffer,produceCachedData:true,});if(script.cachedDataProduced){this._cacheStore.set(filename,invalidationKey,script.cachedData);}elseif(script.cachedDataRejected){this._cacheStore.delete(filename);}varcompiledWrapper=script.runInThisContext({filename:filename,lineOffset:0,columnOffset:0,displayErrors:true,});returncompiledWrapper;}}//------------------------------------------------------------------------------//utilities////https://github.com/substack/node-mkdirp/blob/f2003bb/index.js#L55-L98//https://github.com/zertosh/slash-escape/blob/e7ebb99/slash-escape.js//------------------------------------------------------------------------------functionmkdirpSync(p_){_mkdirpSync(path.resolve(p_),0o777);}function_mkdirpSync(p,mode){try{fs.mkdirSync(p,mode);}catch(err0){if(err0.code==='ENOENT'){_mkdirpSync(path.dirname(p));_mkdirpSync(p);}else{try{conststat=fs.statSync(p);if(!stat.isDirectory()){throwerr0;}}catch(err1){throwerr0;}}}}functionslashEscape(str){constESCAPE_LOOKUP={'\\':'zB',':':'zC','/':'zS','\x00':'z0','z':'zZ',};returnstr.replace(/[\\:\/\x00z]/g,match=>(ESCAPE_LOOKUP[match]));}functionsupportsCachedData(){constscript=newvm.Script('""',{produceCachedData:true});//chakracore,asofv1.7.1.0,returns`false`.returnscript.cachedDataProduced===true;}functiongetCacheDir(){//AvoidcacheownershipissuesonPOSIXsystems.constdirname=typeofprocess.getuid==='function'?'v8-compile-cache-'+process.getuid():'v8-compile-cache';constversion=typeofprocess.versions.v8==='string'?process.versions.v8:typeofprocess.versions.chakracore==='string'?'chakracore-'+process.versions.chakracore:'node-'+process.version;constcacheDir=path.join(os.tmpdir(),dirname,version);returncacheDir;}functiongetParentName(){//`module.parent.filename`isundefinedornullwhen://*node-e'require("v8-compile-cache")'//*node-r'v8-compile-cache'//*Or,requiringfromtheREPL.constparentName=module.parent&&typeofmodule.parent.filename==='string'?module.parent.filename:process.cwd();returnparentName;}//------------------------------------------------------------------------------//main//------------------------------------------------------------------------------if(!process.env.DISABLE_V8_COMPILE_CACHE&&supportsCachedData()){constcacheDir=getCacheDir();constprefix=getParentName();constblobStore=newFileSystemBlobStore(cacheDir,prefix);constnativeCompileCache=newNativeCompileCache();nativeCompileCache.setCacheStore(blobStore);nativeCompileCache.install();process.once('exit',code=>{if(blobStore.isDirty()){blobStore.save();}nativeCompileCache.uninstall();});}module.exports.__TEST__={FileSystemBlobStore,NativeCompileCache,mkdirpSync,slashEscape,supportsCachedData,getCacheDir,getParentName,};